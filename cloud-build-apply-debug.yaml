---
steps:
  - name: gcr.io/cloud-builders/gsutil
    args: ['cp', 'gs://${_PLAN_BUCKET}/variables/01-shared-services-variables.auto.tfvars', '.']
    waitFor: ['-']
  - name: gcr.io/cloud-builders/gsutil
    args: ['cp', 'gs://${_PLAN_BUCKET}/backend/backend.tf', '.']
    waitFor: ['-']
  - name: hashicorp/terraform
    entrypoint: sh
    env:
      - 'TF_LOG=TRACE'
      - 'TF_LOG_PATH=./terraform.log'
    args:
      - -c
      - |
        terraform init
        terraform apply -auto-approve || exit 0
  - name: gcr.io/cloud-builders/gsutil
    args: ['cp', './terraform.log', 'gs://${_PLAN_BUCKET}/errorlogs/terraform-$BUILD_ID.log']
tags:
  - 'pull-apply-debug'
timeout: 7200s