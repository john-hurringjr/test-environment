---
steps:
  - name: gcr.io/cloud-builders/gsutil
    args: ['cp', 'gs://${_PLAN_BUCKET}/variables/test-environment-variables.auto.tfvars', '.']
    waitFor: ['-']
  - name: gcr.io/cloud-builders/gsutil
    args: ['cp', 'gs://${_PLAN_BUCKET}/backend/backend.tf', '.']
    waitFor: ['-']
  - name: hashicorp/terraform
    args:
      - init
  - name: hashicorp/terraform
    args:
      - plan
      - -out=terraform.tfplan
  - name: hashicorp/terraform
    entrypoint: sh
    args:
      - -c
      - |
        export TF_LOG=TRACE
        export TF_LOG_PATH=./terraform.log
  - name: hashicorp/terraform
    args:
      - apply
      - --auto-approve
      - ||
      - exit
      - 0
  - name: gcr.io/cloud-builders/gsutil
    args: ['cp', './terraform.log', 'gs://${_PLAN_BUCKET}/errorlogs/']






#
#
#      - name: hashicorp/terraform
#        entrypoint: sh
#        args:
#          - -c
#          - |
#            export TF_LOG=TRACE
#            export TF_LOG_PATH=./terraform.log
#            cd ~/
#            terraform apply -auto-aprove ./ || exit 0