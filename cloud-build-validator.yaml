---
steps:
  - name: gcr.io/cloud-builders/gsutil
    args: ['cp', 'gs://${_PLAN_BUCKET}/variables/test-environment-variables.auto.tfvars', '.']
    waitFor: ['-']
  - name: gcr.io/cloud-builders/gsutil
    args: ['cp', 'gs://${_PLAN_BUCKET}/backend/backend.tf', '.']
    waitFor: ['-']
  - name: hashicorp/terraform
    args:
      - init
  - name: hashicorp/terraform
    args:
      - plan
      - -out=terraform.tfplan
  - name: hashicorp/terraform
    entrypoint: sh
    args:
      - -c
      - |
        terraform show -json ./terraform.tfplan > ./terraform.tfplan.json
  - name: gcr.io/${_PROJECT_HOSTING_YOUR_VALIDATOR_IMAGE}/terraform-validator
    args:
      - validate
      - terraform.tfplan.json
      -  --policy-path=./policy-library/